@inherits BindableComponentBase<IndexPageViewModel>
@if (DataContext is var d && d?.IsInitialized == true && d.Mode == IndexPageMode.Summary)
{
    <ListScope T="CoordinationViewModel" Source="d.Filtered">
        @if (d.Filtered.Count > 0)
        {
            <div class="coordinations-root">
                @foreach (var ch in d.Filtered.GroupBy(e => e.ChapterId))
                {
                    var hasChapterTitle = false;

                    foreach (var kg in ch.GroupBy(e => e.Kinds))
                    {
                        <div class="group-title">
                            @if (!hasChapterTitle)
                            {
                                hasChapterTitle = true;
                                <h2 class="chapter-title">
                                    @kg.First().ChapterDisplayName
                                </h2>
                            }
                            else
                            {
                                <div class="chapter-title"></div>
                            }
                            <h3 class="kind-title">
                                @kg.Key
                            </h3>
                        </div>
                        <Virtualize Items="kg.OrderBy(e => e.DirectoryNumber).ToList()" Context="c">

                            <div class="coordination">
                                <h4 class="coordination-title">
                                    @c.Name
                                </h4>
                                <div class="coordination-items">
                                    @foreach (var e in c.Items)
                                    {
                        <DataContextScope @key="e.GetHashCode()"
                                      DataContext="e">
                            @{
                                                var lc = e.ListingCount - e.TradingCount;
                            }
                            <div class="coordination-item @(lc > 0 ? "listing" : lc < 0 ? "desired" : null)"
                             title="@e.GetTooltip()"
                             @onclick="@((args => e.ApplyTool(args.AltKey)))">
                                <img class="img-fluid" loading="lazy" src="@e.ImageUrl" style="@(e.IsVisible ? null : "filter:grayscale(1);opacity::0.65;")" />
                                @if (lc > 0)
                                                {
                                    <div class="listing-count">譲: @lc</div>
                                                }
                                                else if (lc < 0)
                                                {
                                    <div class="desired-count">
                                        @if (lc < -1)
                                                        {
                                            @($"求: {-lc}")
                                                        }
                                                        else
                                                        {
                                            @("求")
                                                        }
                                    </div>
                                                }
                            </div>
                        </DataContextScope>
                                    }
                </div>
            </div>
        </Virtualize>
                    }


                }
            </div>
        }
    </ListScope>
}